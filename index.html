<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Attendance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light background */
            color: #334155; /* Darker text */
        }
        /* Custom toggle switch styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #3b82f6; /* Blue for checked */
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #3b82f6;
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(16px);
            -ms-transform: translateX(16px);
            transform: translateX(16px);
        }
        /* Rounded corners for tables and cells */
        table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden; /* Ensures rounded corners are visible */
        }
        th, td {
            padding: 0.75rem 1rem; /* p-3 p-4 */
            border-bottom: 1px solid #e2e8f0; /* border-b border-gray-200 */
        }
        th {
            background-color: #e2e8f0; /* bg-gray-200 */
            text-align: left;
            font-weight: 600; /* font-semibold */
        }
        tr:last-child td {
            border-bottom: none;
        }
        .highlight-current-day {
            background-color: #dbeafe; /* Light blue for current day */
            font-weight: 600;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 400px;
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 1.5rem;
        }
        .modal-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .modal-buttons .confirm-button {
            background-color: #3b82f6;
            color: white;
        }
        .modal-buttons .confirm-button:hover {
            background-color: #2563eb;
        }
        .modal-buttons .cancel-button {
            background-color: #e2e8f0;
            color: #334155;
        }
        .modal-buttons .cancel-button:hover {
            background-color: #cbd5e1;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-xl p-6 sm:p-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6 text-gray-800">Office Attendance Tracker</h1>

        <!-- <div id="user-id-display" class="text-sm text-gray-600 text-center mb-4">
            Your User ID: <span id="current-user-id" class="font-mono bg-gray-100 px-2 py-1 rounded">Loading...</span>
        </div> -->

        <div id="loading-indicator" class="text-center text-blue-600 mb-4">
            Loading attendance data...
        </div>

        <div id="error-message" class="text-center text-red-600 mb-4 hidden">
            Error loading data. Please try again.
        </div>

        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Current Week</h2>
        <div class="overflow-x-auto mb-8">
            <table id="current-week-table" class="min-w-full bg-white rounded-xl shadow-md">
                <thead>
                    <tr id="current-week-header-row">
                        </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Next Week</h2>
        <div class="overflow-x-auto">
            <table id="next-week-table" class="min-w-full bg-white rounded-xl shadow-md">
                <thead>
                    <tr id="next-week-header-row">
                        </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Confirm Attendance Change</h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <div class="modal-buttons">
                <button id="confirm-yes" class="confirm-button">Confirm</button>
                <button id="confirm-no" class="cancel-button">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // === JSONbin.io Configuration ===
        // 1. Go to https://jsonbin.io/, sign up, and create a new bin.
        // 2. Paste your Bin ID here:
        const JSONBIN_BIN_ID = "YOUR_JSONBIN_BIN_ID_HERE"; // e.g., "60f..."
        // 3. If you want to enable write access (recommended for this app),
        //    go to "API Keys" in JSONbin.io, create a Master Key, and paste it here.
        //    If you leave this empty, the app will be read-only.
        const JSONBIN_MASTER_KEY = "YOUR_JSONBIN_MASTER_KEY_HERE"; // e.g., "$2b$10$..."

        const JSONBIN_API_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
        // ================================

        // === EDIT THESE NAMES TO CUSTOMIZE THE PEOPLE IN THE TRACKER ===
        const personNames = [
            "Alice",
            "Bob",
            "Charlie",
            "David",
            "Eve"
        ];
        // =============================================================

        let currentAttendanceData = {}; // Stores the latest attendance data from JSONbin

        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        const confirmYesBtn = document.getElementById('confirm-yes');
        const confirmNoBtn = document.getElementById('confirm-no');

        let pendingToggleEvent = null; // To store the event object of the toggle click

        /**
         * Fetches attendance data from JSONbin.io.
         * @returns {Promise<Object>} A promise that resolves with the attendance data.
         */
        async function fetchAttendanceFromJSONbin() {
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            try {
                const response = await fetch(JSONBIN_API_URL, {
                    headers: {
                        'X-Master-Key': JSONBIN_MASTER_KEY // Master key for read access (optional, but good practice)
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                // JSONbin.io wraps the data in a 'record' key
                return data.record || {};
            } catch (error) {
                console.error("Error fetching attendance data from JSONbin:", error);
                let userMessage = `Error loading data: ${error.message}. Please ensure your JSONBIN_BIN_ID is correct.`;
                if (error.message.includes("NetworkError")) {
                    userMessage += " If you are running this file directly from your computer (e.g., 'file:///'), try deploying it to a web server (like Firebase Hosting or Netlify) as browsers often block data requests from local files due to security policies (CORS).";
                }
                errorMessage.textContent = userMessage;
                errorMessage.classList.remove('hidden');
                return {}; // Return empty object on error
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Updates attendance data on JSONbin.io.
         * @param {Object} newData - The full attendance data object to save.
         * @returns {Promise<boolean>} A promise that resolves to true if successful, false otherwise.
         */
        async function updateAttendanceOnJSONbin(newData) {
            errorMessage.classList.add('hidden'); // Clear previous errors
            if (!JSONBIN_MASTER_KEY) {
                errorMessage.textContent = "Master Key is missing. Cannot update data. Please add JSONBIN_MASTER_KEY in the code.";
                errorMessage.classList.remove('hidden');
                return false;
            }

            try {
                const response = await fetch(JSONBIN_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_MASTER_KEY, // Master key for write access
                        'X-Bin-Meta': 'false' // To return only the data, not metadata
                    },
                    body: JSON.stringify(newData)
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                await response.json(); // Parse response to ensure it's complete
                return true;
            } catch (error) {
                console.error("Error updating attendance data on JSONbin:", error);
                let userMessage = `Failed to update attendance: ${error.message}. Please check your JSONBIN_MASTER_KEY.`;
                if (error.message.includes("NetworkError")) {
                    userMessage += " If you are running this file directly from your computer (e.g., 'file:///'), try deploying it to a web server (like Firebase Hosting or Netlify) as browsers often block data requests from local files due to security policies (CORS).";
                }
                errorMessage.textContent = userMessage;
                errorMessage.classList.remove('hidden');
                return false;
            }
        }

        /**
         * Generates an array of dates for the specified week, Monday to Friday.
         * @param {Date} startDate - The starting date of the week (e.g., a Monday).
         * @returns {Array<Object>} An array of date objects with date string and day name.
         */
        function getWeekDays(startDate) {
            const days = [];
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const options = { month: 'short', day: 'numeric', year: 'numeric' };

            // Ensure startDate is a Monday (or adjust if it's not)
            const currentDay = startDate.getDay(); // 0 for Sunday, 1 for Monday
            const diff = startDate.getDate() - currentDay + (currentDay === 0 ? -6 : 1); // Adjust to Monday
            const monday = new Date(startDate.setDate(diff));

            for (let i = 0; i < 5; i++) { // Monday to Friday (5 days)
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                days.push({
                    dateString: date.toLocaleDateString('en-US', options),
                    dayName: dayNames[date.getDay()],
                    id: date.toISOString().split('T')[0] //YYYY-MM-DD format for data key
                });
            }
            return days;
        }

        /**
         * Renders the table headers (Date & Day and Person Names).
         * @param {HTMLElement} headerRow - The tr element in the thead to render into.
         */
        function renderTableHeaders(headerRow) {
            headerRow.innerHTML = ''; // Clear existing headers

            // Add Date & Day header
            const dateDayHeader = document.createElement('th');
            dateDayHeader.classList.add('px-4', 'py-3', 'rounded-tl-xl');
            dateDayHeader.textContent = 'Date & Day';
            headerRow.appendChild(dateDayHeader);

            // Add Person Name headers
            personNames.forEach((name, index) => {
                const personHeader = document.createElement('th');
                personHeader.classList.add('px-4', 'py-3');
                personHeader.textContent = name;
                if (index === personNames.length - 1) {
                    personHeader.classList.add('rounded-tr-xl'); // Rounded corner for the last header
                }
                headerRow.appendChild(personHeader);
            });
        }

        /**
         * Renders the attendance table for a given week.
         * @param {HTMLElement} tableBody - The tbody element to render into.
         * @param {Array<Object>} weekDates - Array of date objects for the week.
         * @param {Object} attendanceData - Current attendance data from JSONbin.
         */
        function renderAttendanceTable(tableBody, weekDates, attendanceData) {
            tableBody.innerHTML = ''; // Clear existing rows
            const today = new Date().toISOString().split('T')[0]; //YYYY-MM-DD

            weekDates.forEach(day => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50'); // Hover effect
                if (day.id === today) {
                    row.classList.add('highlight-current-day');
                }

                const dateCell = document.createElement('td');
                dateCell.classList.add('px-4', 'py-3', 'font-medium');
                dateCell.textContent = `${day.dateString} (${day.dayName})`;
                row.appendChild(dateCell);

                // Add cells for each person based on personNames array length
                personNames.forEach((name, index) => {
                    const personCell = document.createElement('td');
                    personCell.classList.add('px-4', 'py-3', 'text-center');

                    // Use a generic personId (e.g., person0, person1) for data keys
                    const personId = `person${index}`;
                    const isComing = attendanceData[day.id] ? attendanceData[day.id][personId] || false : false;

                    // Create a custom toggle switch
                    const label = document.createElement('label');
                    label.classList.add('toggle-switch');

                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.checked = isComing;
                    input.dataset.dateId = day.id;
                    input.dataset.personId = personId; // Data key
                    input.dataset.personDisplayName = name; // Display name for modal
                    input.dataset.dateString = day.dateString; // Store date string for modal
                    input.dataset.dayName = day.dayName;     // Store day name for modal
                    // Store the original state for potential revert
                    input.dataset.originalChecked = isComing;

                    // Event listener for toggle change - show confirmation modal
                    input.addEventListener('change', (event) => {
                        pendingToggleEvent = event; // Store the event
                        const dateString = event.target.dataset.dateString;
                        const dayName = event.target.dataset.dayName;
                        const personDisplayName = event.target.dataset.personDisplayName; // Get display name
                        const newValue = event.target.checked;
                        const action = newValue ? 'coming to office' : 'not coming to office';

                        // Update modal message with highlighted action and full date/day
                        modalMessage.innerHTML = `Are you sure you want to mark <strong>${personDisplayName}</strong> as <strong>${action}</strong> on <strong>${dateString} (${dayName})</strong>?`;
                        confirmationModal.classList.remove('hidden');
                    });

                    const slider = document.createElement('span');
                    slider.classList.add('slider');

                    label.appendChild(input);
                    label.appendChild(slider);
                    personCell.appendChild(label);
                    row.appendChild(personCell);
                });
                tableBody.appendChild(row);
            });
        }

        /**
         * Handles the confirmation of a toggle action.
         */
        confirmYesBtn.addEventListener('click', async () => {
            if (pendingToggleEvent) {
                const event = pendingToggleEvent;
                const dateId = event.target.dataset.dateId;
                const pId = event.target.dataset.personId;
                const value = event.target.checked;

                // Create a copy of the current data to modify
                const updatedData = { ...currentAttendanceData };
                if (!updatedData[dateId]) {
                    updatedData[dateId] = {};
                }
                updatedData[dateId][pId] = value;

                const success = await updateAttendanceOnJSONbin(updatedData);

                if (success) {
                    console.log(`Attendance for ${pId} on ${dateId} updated to ${value} on JSONbin.`);
                    currentAttendanceData = updatedData; // Update local cache on success
                    event.target.dataset.originalChecked = value; // Update original state
                    // Re-render the tables to reflect the change (optional, but good for consistency)
                    // This is less critical with JSONbin.io as there's no real-time listener like Firestore's onSnapshot
                    // If multiple users are editing, they'd need to refresh or the app would need polling.
                    // For simplicity, we'll just update the local UI.
                    renderAttendance();
                } else {
                    // Revert checkbox state on error
                    event.target.checked = !value;
                    event.target.dataset.originalChecked = !value;
                }
                confirmationModal.classList.add('hidden');
                pendingToggleEvent = null;
            }
        });

        /**
         * Handles the cancellation of a toggle action.
         */
        confirmNoBtn.addEventListener('click', () => {
            if (pendingToggleEvent) {
                // Revert the checkbox to its original state
                const originalState = pendingToggleEvent.target.dataset.originalChecked === 'true';
                pendingToggleEvent.target.checked = originalState;
            }
            confirmationModal.classList.add('hidden');
            pendingToggleEvent = null;
        });

        /**
         * Main function to fetch and render attendance data.
         */
        async function renderAttendance() {
            // Render table headers first
            renderTableHeaders(document.getElementById('current-week-table').querySelector('thead tr'));
            renderTableHeaders(document.getElementById('next-week-table').querySelector('thead tr'));

            currentAttendanceData = await fetchAttendanceFromJSONbin();

            // Get current and next week dates
            const today = new Date();
            const currentWeekMonday = new Date(today);
            currentWeekMonday.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1)); // Adjust to Monday

            const nextWeekMonday = new Date(currentWeekMonday);
            nextWeekMonday.setDate(currentWeekMonday.getDate() + 7);

            const currentWeekDates = getWeekDays(currentWeekMonday);
            const nextWeekDates = getWeekDays(nextWeekMonday);

            // Render tables
            renderAttendanceTable(document.getElementById('current-week-table').querySelector('tbody'), currentWeekDates, currentAttendanceData);
            renderAttendanceTable(document.getElementById('next-week-table').querySelector('tbody'), nextWeekDates, currentAttendanceData);
        }

        // Initialize the app when the window loads
        window.onload = renderAttendance;
    </script>
</body>
</html>
